<!DOCTYPE html>
<html>

<head>
    <title>Teste 3</title>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: sans-serif;
            color: #fff
        }

        .ui {
            position: fixed;
            top: 20px;
            left: 20px;
            background: #0009;
            padding: 15px;
            border: 1px solid #9370DB;
            border-radius: 10px;
            width: 280px;
            pointer-events: none
        }

        .nav {
            position: fixed;
            top: 20px;
            right: 20px;
            pointer-events: auto
        }

        button {
            border: 0;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin-left: 5px
        }
    </style>
    <script>
        AFRAME.registerComponent('cd', {
            schema: { alvo: { type: 'string' }, desl: { type: 'vec3' } },
            init() { this.v = new THREE.Vector3() },
            tick() {
                let t = this.t || (this.t = document.querySelector('#' + this.data.alvo));
                if (t) this.el.object3D.position.lerp(this.v.copy(t.object3D.position).add(this.data.desl), 0.6);
            }
        });
    </script>
</head>

<body>
    <div class="ui">
        <h3 style="color:#9370DB;margin:0 0 5px">Visual Final</h3>
        <p style="font-size:13px;margin:0">Cauda Cônica + Rastro Tracejado Progressivo.</p>
    </div>
    <div class="nav">
        <button onclick="location='index.html'" style="background:#444;color:#fff">Cena 1</button>
        <button onclick="location='cena2.html'" style="background:#deb0fc">Cena 2</button>
    </div>

    <a-scene id="s" shadow="type:pcfsoft">
        <a-assets>
            <img id="iS"
                src="https://upload.wikimedia.org/wikipedia/commons/thumb/9/99/Map_of_the_full_sun.jpg/1280px-Map_of_the_full_sun.jpg">
            <img id="iT"
                src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/23/Blue_Marble_2002.png/1280px-Blue_Marble_2002.png">
            <img id="iC" src="https://jocoteles.github.io/Minicurso-A-Frame-VR/TychoSkymap.t4_04096x02048.jpg">
        </a-assets>
        <a-sky src="#iC" rotation="0 -90 0"></a-sky>
        <a-entity light="type:ambient;color:#444"></a-entity>
        <a-entity light="type:directional;color:#fff;intensity:1.5;castShadow:true" position="-10 10 -10"></a-entity>
        <a-sphere position="-20 15 -20" src="#iS" radius="5" material="shader:flat"></a-sphere>
        <a-entity position="0 -4 -8" rotation="0 0 23.4">
            <a-sphere src="#iT" radius="6" shadow="receive:true"></a-sphere>
            <a-sphere radius="9"
                material="color:#87CEEB;opacity:0.15;transparent:true;side:back;blending:additive"></a-sphere>
        </a-entity>
    </a-scene>

    <script>
        let uid = 0, P = AFRAME.utils.coordinates.parse;
        const $el = (p, t, a) => { let e = document.createElement(t); for (let k in a) e.setAttribute(k, a[k]); p.appendChild(e); return e; };
        const anim = (p, to, d, dly, fr) => `property:${p}; ${fr ? `from:${fr};` : ''} to:${to}; dur:${d}; delay:${dly}; easing:linear`;

        // --- GERADOR (COM RASTRO PROGRESSIVO) ---
        const gerar = (pai, ini, fim, cor, tam, dly, dur) => {
            const p1 = P(ini), p2 = P(fim);
            const id = 'p' + uid++, dist = Math.sqrt((p2.x - p1.x) ** 2 + (p2.y - p1.y) ** 2 + (p2.z - p1.z) ** 2);
            const ang = -Math.atan2(p2.x - p1.x, p2.y - p1.y) * (180 / Math.PI);

            // 1. Cabeça (Esfera)
            $el(pai, 'a-entity', {
                id: id, position: ini, visible: false, geometry: `primitive:sphere; radius:${0.06 * tam}`, material: `shader:flat; color:${cor}`,
                animation__v: `property:visible; to:true; dur:0; delay:${dly}`,
                animation__m: anim('position', fim, dur, dly, ini),
                animation__s: `property:scale; to:0 0 0; dur:150; delay:${dly + dur}`
            });

            // 2. Cauda (Cone)
            const h = 1.2 * tam, off = h / 2, len = Math.sqrt((p2.x - p1.x) ** 2 + (p2.y - p1.y) ** 2) || 1;
            const oX = -(p2.x - p1.x) / len * off, oY = -(p2.y - p1.y) / len * off;
            $el(pai, 'a-entity', {
                geometry: `primitive:cone; radiusBottom:${0.06 * tam}; radiusTop:0.01; height:${h}`,
                material: `shader:flat; color:${cor}`, position: `${p1.x + oX} ${p1.y + oY} ${p1.z}`, rotation: `0 0 ${ang + 180}`,
                cd: `alvo:${id}; desl:${oX} ${oY} 0`, visible: false, scale: '0 0 0',
                animation__v: `property:visible; to:true; dur:0; delay:${dly}`,
                animation__g: `property:scale; to:1 1 1; dur:300; delay:${dly}`,
                animation__s: `property:scale; to:0 0 0; dur:300; delay:${dly + dur - 100}`
            });

            // 3. Rastro (Tracejado Progressivo)
            if (tam > 0.1) { // Só cria rastro se não for muito pequeno
                const qtd = Math.floor(dist / 0.6);
                for (let i = 0; i < qtd; i++) {
                    let t = i / qtd, px = p1.x + (p2.x - p1.x) * t, py = p1.y + (p2.y - p1.y) * t, pz = p1.z + (p2.z - p1.z) * t;
                    $el(pai, 'a-entity', {
                        geometry: `primitive:cylinder; radius:0.01; height:0.2`, material: `shader:flat; color:${cor}; opacity:0.5`,
                        position: `${px} ${py} ${pz}`, rotation: `0 0 ${ang}`, visible: false,
                        animation__v: `property:visible; to:true; dur:0; delay:${dly + dur * t}`, // Delay progressivo
                        animation__s: `property:scale; to:0 0 0; dur:300; delay:${dly + dur}`
                    });
                }
            }
        };

        const chuva = () => {
            const c = $el(document.querySelector('#s'), 'a-entity', { position: `${(Math.random() * 8) - 4} 0 -8` });
            const tR = 1500, tP = 500, tF = 1200;

            // 1. Raio
            gerar(c, '0 12 0', '0 5 0', '#FF4500', 1.0, 0, tR);

            // 2. Pais
            const gPai = (x) => gerar(c, '0 5 0', `${x} 3.5 0`, '#9370DB', 1.3, tR, tP);
            gPai(-0.6); gPai(0.6);

            // 3. Filhos
            const gFilho = (xI, xF) => gerar(c, `${xI} 3.5 0`, `${xF} 0.5 0`, '#FFB6C1', 0.8, tR + tP, tF);
            gFilho(-0.6, -1.8); gFilho(-0.6, -0.4);
            gFilho(0.6, 0.4); gFilho(0.6, 1.8);

            setTimeout(() => c.remove(), tR + tP + tF + 1000);
        };

        setInterval(chuva, 2500);
        onload = () => setTimeout(chuva, 500);
    </script>
</body>

</html>